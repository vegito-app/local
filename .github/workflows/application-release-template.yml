#######################################################################
# MIGRATION EN COURS : Les artefacts sont d√©sormais √† uploader vers GCS directement
# Les uploads via actions/upload-artifact@v4 sont d√©sactiv√©s ou √† d√©sactiver.
# TODO: Nettoyer les d√©pendances et le workflow complet pour full GCS.
#######################################################################
name: Application Release Pipeline

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      environment:
        required: true
        type: string
        default: ${{ github.repository }}
      application_release_bucket_project_prefix:
        required: false
        type: string
        default: local
      release_bucket_name:
        required: true
        type: string
      release_bucket_prefix:
        required: false
        type: string
        default: ${{ github.repository }}
      use_registry_cache:
        required: false
        type: boolean
        default: true
    secrets:
      GOOGLE_CLOUD_PROJECT_ID:
        required: true
      GOOGLE_CLOUD_SA_KEY_GITHUB_ACTIONS_MAIN:
        required: true
      WORKLOAD_IDENTITY_PROVIDER:
        required: true

permissions:
  id-token: write
  contents: write

jobs:
  create-github-release:
    name: Create Consolidated GitHub Release ‚ú®
    runs-on: self-hosted
    environment: ${{ inputs.environment }}
    env:
      VERSION: ${{ inputs.version }}
      VEGITO_APPLICATION_RELEASE_PROJECT: ${{ inputs.application_release_bucket_project_prefix }}
      VEGITO_APPLICATION_RELEASE_BUCKET: ${{ inputs.release_bucket_name }}/${{ inputs.release_bucket_prefix }}
      LOCAL_ANDROID_MOBILE_KEYSTORE_SHA1_EXTRACT_PATH: android-mobile-release-${{ inputs.version }}-key.keystore.sha1
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- REMPLACEMENT : R√©cup√©ration du changelog directement depuis GCS ---
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GOOGLE_CLOUD_SA_KEY_GITHUB_ACTIONS_MAIN }}
          project_id: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
          token_format: "access_token"
          export_environment_variables: true

      - name: Download version changelog from GCS
        run: |
          mkdir -p ./artifacts
          gcloud storage cp gs://${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/CHANGELOG.md ./artifacts/CHANGELOG.md

      - name: Write changelog and release body
        run: |
          VERSION="${{ env.VERSION }}"
          echo "" > RELEASE_BODY.md
          echo "## üì¶ Build Artifacts (Vegito)" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "See the full list of build artifacts for this release at:" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "üîó **[Download from GCS release bucket of project \`${VEGITO_APPLICATION_RELEASE_PROJECT}\` ‚Äì version \`${VERSION}\`](https://release.vegito.app/releases?project=${VEGITO_APPLICATION_RELEASE_PROJECT}&version=${VERSION})**" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "### üì± Download and Preview" >> RELEASE_BODY.md
          echo '<div style="display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;">' >> RELEASE_BODY.md
          echo '  <div style="text-align: center;">' >> RELEASE_BODY.md
          echo "    <img src=\"https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/qr-code.png\" alt=\"QR Code\" width=\"140\" height=\"140\"/>" >> RELEASE_BODY.md
          echo "    <div>‚û°Ô∏è <a href=\"https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/app-release.apk\">Download APK</a></div>" >> RELEASE_BODY.md
          echo '  </div>' >> RELEASE_BODY.md
          echo '  <div>' >> RELEASE_BODY.md
          echo "    <img src=\"https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/mobile/android-preview.png\" alt=\"App Screenshot\" style=\"max-height: 160px; border: 1px solid #ccc;\"/>" >> RELEASE_BODY.md
          echo '  </div>' >> RELEASE_BODY.md
          echo '</div>' >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "---" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "## üì¶ [Production] Artifacts (GCS)" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "- üîó [Download APK](https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/app-release.apk)" >> RELEASE_BODY.md
          echo "- üîó [Download AAB](https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/app-release.aab)" >> RELEASE_BODY.md
          echo "- üîó [Android Release Keystore SHA1](https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/app-release.keystore.sha1)" >> RELEASE_BODY.md
          echo "- üß™ [Test Report (Robot Framework)](https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/tests/report.html)" >> RELEASE_BODY.md
          echo "- üß™ [Test Log](https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/tests/log.html)" >> RELEASE_BODY.md
          echo "- üìä [Test Output (XML)](https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/tests/output.xml)" >> RELEASE_BODY.md
          echo "- üßæ [Build Log](https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/build/images-build.html)" >> RELEASE_BODY.md
          echo "- üßæ [Docker Tags](https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/docker-tags.md)" >> RELEASE_BODY.md
          echo "_Generated automatically by Vegito CI/CD pipeline üß±_" >> RELEASE_BODY.md
          echo "# üöÄ Release $VERSION" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "## üß© Changes included:" >> RELEASE_BODY.md
          cat ./artifacts/CHANGELOG.md >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md

      # --- T√©l√©chargement minimal des artefacts n√©cessaires √† la g√©n√©ration du RELEASE_BODY.md ---
      - name: Download environment artifacts from GCS (minimal)
        run: |
          set -euo pipefail
          env_artifacts_dir="./artifacts/${{ inputs.environment }}"
          mkdir -p "$env_artifacts_dir"

          gcloud storage cp \
            "gs://${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/docker-tags.md" \
            "$env_artifacts_dir/docker-tags.md" || true

          gcloud storage cp \
            "gs://${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/android-mobile-release-${VERSION}-key.keystore.sha1" \
            "$env_artifacts_dir/android-mobile-release-${VERSION}-key.keystore.sha1" || true

      - name: Download Robot Framework artifacts from GCS
        run: |
          set -euo pipefail
          tests_dir="./artifacts/${{ inputs.environment }}/tests"
          mkdir -p "$tests_dir"

          gcloud storage cp \
            "gs://${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/tests/report.html" \
            "$tests_dir/report.html" || true

          gcloud storage cp \
            "gs://${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/tests/log.html" \
            "$tests_dir/log.html" || true

          gcloud storage cp \
            "gs://${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/tests/output.xml" \
            "$tests_dir/output.xml" || true

      - name: Append environment-specific information to changelog
        run: |
          set -euo pipefail
          for env in prod staging dev; do
            echo -e "\n\n---\n\n" >> RELEASE_BODY.md
            echo "### [$env] Environment Artifacts:" >> RELEASE_BODY.md
            echo "" >> RELEASE_BODY.md
            
            # Append Android keystore SHA1 if available
            keystore_sha1_path="./artifacts/$env/android-mobile-release-${VERSION}-key.keystore.sha1"
            if [ -f "$keystore_sha1_path" ]; then
              echo "**Android Release Keystore SHA1:**" >> RELEASE_BODY.md
              echo '```' >> RELEASE_BODY.md
              cat "$keystore_sha1_path" >> RELEASE_BODY.md
              echo '' >> RELEASE_BODY.md
              echo '```' >> RELEASE_BODY.md
              echo "" >> RELEASE_BODY.md
            fi

            docker_tags_path="./artifacts/$env/docker-tags.md"
            if [ -f "$docker_tags_path" ]; then
              echo "**Docker images published:**" >> RELEASE_BODY.md
              cat "$docker_tags_path" >> RELEASE_BODY.md
              echo "" >> RELEASE_BODY.md
            fi

            tests_dir="./artifacts/$env/tests"
            if [ -d "$tests_dir" ]; then
              if [ -f "$tests_dir/report.html" ] || [ -f "$tests_dir/log.html" ] || [ -f "$tests_dir/output.xml" ]; then
                echo "**Robot Framework Tests:**" >> RELEASE_BODY.md
                [ -f "$tests_dir/report.html" ] && echo "- üß™ Test Report: https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/tests/report.html" >> RELEASE_BODY.md
                [ -f "$tests_dir/log.html" ] && echo "- üß™ Test Log: https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/tests/log.html" >> RELEASE_BODY.md
                [ -f "$tests_dir/output.xml" ] && echo "- üìä Test Output (XML): https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/tests/output.xml" >> RELEASE_BODY.md
                echo "" >> RELEASE_BODY.md
              fi
            fi
          done

      - name: Show Release Body preview
        run: |
          cat RELEASE_BODY.md

      - name: Create GitHub Release ‚ú®
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: main-${{ env.VERSION }}
          name: Release ${{ env.VERSION }}
          body_path: ./RELEASE_BODY.md

  commit-and-push-release-tag:
    name: Finalize and Push Release Tag
    runs-on: self-hosted
    needs: [create-github-release, upload-release-to-gcs]
    if: success()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Reset to clean state
        run: |
          git fetch origin main
          git reset --hard origin/main

      - name: Run Gitleaks scan
        run: |
          gitleaks detect --source . --report-path gitleaks-report.json --log-opts "--all"

      # - name: Upload Gitleaks report as artifact
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: gitleaks-report
      #     path: gitleaks-report.json
      # TODO: Uploader direct vers GCS √† la g√©n√©ration (gitleaks-report.json)

      - name: Fail if leaks found
        run: |
          if grep -q '"line":' gitleaks-report.json; then
            echo "üö® Secrets found, stopping build!"
            exit 1
          fi

      - name: Recreate version tag
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "build-and-push-images-action@github.com"
          standard-version

      - name: Push tag if all builds succeeded
        run: |
          git push origin HEAD --follow-tags

  upload-release-to-gcs:
    name: Upload artifacts and metadata to GCS
    runs-on: self-hosted
    environment: ${{ inputs.environment }}
    env:
      VERSION: ${{ inputs.version }}
      VEGITO_PROJECT_USER: gha-${{ github.run_id }}-${{ inputs.environment }}
      GOOGLE_CLOUD_PROJECT_ID: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
      GOOGLE_CLOUD_PROJECT_NUMBER: ${{ secrets.GOOGLE_CLOUD_PROJECT_NUMBER }}
      WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
      GOOGLE_CLOUD_SA_KEY_GITHUB_ACTIONS_MAIN: ${{ secrets.GOOGLE_CLOUD_SA_KEY_GITHUB_ACTIONS_MAIN }}
      INFRA_ENV: ${{ inputs.environment }}
      VEGITO_APPLICATION_RELEASE_BUCKET: ${{ inputs.release_bucket_name }}/${{ inputs.release_bucket_prefix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set VERSION
        run: echo "VERSION=${{ env.VERSION }}" >> $GITHUB_ENV

      - name: Authenticate to Google Cloud via Workload Identity Federation
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.GOOGLE_CLOUD_SA_KEY_GITHUB_ACTIONS_MAIN }}
          project_id: ${{ env.GOOGLE_CLOUD_PROJECT_ID }}
          token_format: "access_token"
          export_environment_variables: true

      - name: Download docker metadata artifact from GCS
        run: |
          mkdir -p ./artifacts
          gcloud storage cp "gs://${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/docker-tags.md" ./artifacts/docker-tags.md

      - name: Download build log artifact from GCS
        run: |
          mkdir -p ./artifacts/build
          gcloud storage cp "gs://${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/images-build.log" ./artifacts/images-build.log

      - name: Download dev logs from GCS
        if: env.INFRA_ENV == 'dev'
        run: |
          mkdir -p ./artifacts
          gcloud storage cp "gs://${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/functional-tests/setup.log" ./artifacts/setup.log
          gcloud storage cp "gs://${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/functional-tests/containers.log" ./artifacts/containers.log
          gcloud storage cp "gs://${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/functional-tests/tests.log" ./artifacts/tests.log

      - name: Upload metadata.json and APK/AAB to GCS
        run: |
          apkUrl="https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/android-mobile-release-${VERSION}-signed-aligned.apk"

          qrencode -o ./artifacts/qr-code.png "${apkUrl}"

          if [ -f ./artifacts/containers.log ]; then
            echo "<html><body><pre>" > ./artifacts/containers.html
            cat ./artifacts/containers.log >> ./artifacts/containers.html
            echo "</pre></body></html>" >> ./artifacts/containers.html
          fi

          if [ -f ./artifacts/setup.log ]; then
            echo "<html><body><pre>" > ./artifacts/setup.html
            cat ./artifacts/setup.log >> ./artifacts/setup.html
            echo "</pre></body></html>" >> ./artifacts/setup.html
          fi

          if [ -f ./artifacts/tests.log ]; then
            echo "<html><body><pre>" > ./artifacts/tests.html
            cat ./artifacts/tests.log >> ./artifacts/tests.html
            echo "</pre></body></html>" >> ./artifacts/tests.html
          fi

          if [ -f ./artifacts/images-build.log ]; then
            echo "<html><body><pre>" > ./artifacts/images-build.html
            cat ./artifacts/images-build.log >> ./artifacts/images-build.html
            echo "</pre></body></html>" >> ./artifacts/images-build.html
          fi

          mkdir -p temp_metadata
          METADATA_PATH=temp_metadata/metadata.json
          cat <<EOF > $METADATA_PATH
          {
            "version": "${VERSION}",
            "changelog": "https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/CHANGELOG.md",
            "dockerTags": "https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/docker-tags.md",
            "apk": "${apkUrl}",
            "aab": "https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/android-mobile-release-${VERSION}-signed.aab",
            "androidKeystoreSha1": "https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/android-mobile-release-${VERSION}-key.keystore.sha1",
            "thumbnail": "https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/android-mobile-preview.png",
            "robotReport": "https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/functional-tests/output/report.html",
            "robotLog": "https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/functional-tests/output/log.html",
            "robotXml": "https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/functional-tests/output/output.xml",
            "buildImages": "https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/images-build.html",
            "buildImagesLog": "https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/images-build.log",
            "devTests": "https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/functional-tests/tests.html",
            "devTestsLog": "https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/functional-tests/tests.log",
            "devContainers": "https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/functional-tests/containers.html",
            "devContainersLog": "https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/functional-tests/containers.log",
            "devSetup": "https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/functional-tests/setup.html",
            "devSetupLog": "https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/functional-tests/setup.log",
            "qr": "https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/qr-code.png"
          }
          EOF

          gcloud storage cp "$METADATA_PATH" "gs://${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/metadata.json" --quiet
          gcloud storage cp ./artifacts/images-build.html "gs://${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/images-build.html" --quiet
          # Upload dev logs uniquement si env == dev
          if [ "$INFRA_ENV" = "dev" ]; then
            gcloud storage cp ./artifacts/tests.html "gs://${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/tests.html" --quiet || true
            gcloud storage cp ./artifacts/setup.html "gs://${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/setup.html" --quiet || true
            gcloud storage cp ./artifacts/containers.html "gs://${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/containers.html" --quiet
          fi

          gcloud storage cp ./artifacts/qr-code.png "gs://${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/qr-code.png" --quiet
