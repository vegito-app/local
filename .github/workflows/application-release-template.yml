#######################################################################
# MIGRATION EN COURS : Les artefacts sont d√©sormais √† uploader vers GCS directement
# Les uploads via actions/upload-artifact@v4 sont d√©sactiv√©s ou √† d√©sactiver.
# TODO: Nettoyer les d√©pendances et le workflow complet pour full GCS.
#######################################################################
name: Application Release Pipeline

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      environment:
        required: true
        type: string
      application_release_bucket_prefix:
        required: false
        type: string
        default: ${{ github.repository }}
      application_release_bucket_project_prefix:
        required: false
        type: string
        default: local
      use_registry_cache:
        required: false
        type: boolean
        default: true
    secrets:
      GOOGLE_CLOUD_PROJECT_ID:
        required: true
      GOOGLE_CLOUD_SA_KEY_GITHUB_ACTIONS_MAIN:
        required: true
      WORKLOAD_IDENTITY_PROVIDER:
        required: true

permissions:
  id-token: write
  contents: write

jobs:
  create-github-release:
    name: Create Consolidated GitHub Release ‚ú®
    runs-on: self-hosted
    environment: ${{ inputs.environment }}
    env:
      VERSION: ${{ inputs.version }}
      VEGITO_APPLICATION_RELEASE_PROJECT: ${{ inputs.application_release_bucket_project_prefix }}
      VEGITO_APPLICATION_RELEASE_BUCKET: vegito-app-${{ inputs.environment }}-github-actions-ci-artifacts/${{ inputs.application_release_bucket_prefix }}
      LOCAL_ANDROID_MOBILE_KEYSTORE_SHA1_EXTRACT_PATH: android-mobile-release-${{ inputs.version }}-key.keystore.sha1
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- REMPLACEMENT : R√©cup√©ration du changelog directement depuis GCS ---
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GOOGLE_CLOUD_SA_KEY_GITHUB_ACTIONS_MAIN }}
          project_id: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
          token_format: "access_token"
          export_environment_variables: true

      - name: Download version changelog from GCS
        run: |
          mkdir -p ./artifacts
          gcloud storage cp gs://${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/CHANGELOG.md ./artifacts/CHANGELOG.md

      - name: Write changelog and release body
        run: |
          VERSION="${{ env.VERSION }}"
          echo "" > RELEASE_BODY.md
          echo "## üì¶ Build Artifacts (Vegito)" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "See the full list of build artifacts for this release at:" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "üîó **[Download from GCS release bucket of project \`${VEGITO_APPLICATION_RELEASE_PROJECT}\` ‚Äì version \`${VERSION}\`](https://release.vegito.app/releases?project=${VEGITO_APPLICATION_RELEASE_PROJECT}&version=${VERSION})**" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "### üì± Download and Preview" >> RELEASE_BODY.md
          echo '<div style="display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;">' >> RELEASE_BODY.md
          echo '  <div style="text-align: center;">' >> RELEASE_BODY.md
          echo "    <img src=\"https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/qr-code.png\" alt=\"QR Code\" width=\"140\" height=\"140\"/>" >> RELEASE_BODY.md
          echo "    <div>‚û°Ô∏è <a href=\"https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/app-release.apk\">Download APK</a></div>" >> RELEASE_BODY.md
          echo '  </div>' >> RELEASE_BODY.md
          echo '  <div>' >> RELEASE_BODY.md
          echo "    <img src=\"https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/mobile/android-preview.png\" alt=\"App Screenshot\" style=\"max-height: 160px; border: 1px solid #ccc;\"/>" >> RELEASE_BODY.md
          echo '  </div>' >> RELEASE_BODY.md
          echo '</div>' >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "---" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "## üì¶ [Production] Artifacts (GCS)" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "- üîó [Download APK](https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/app-release.apk)" >> RELEASE_BODY.md
          echo "- üîó [Download AAB](https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/app-release.aab)" >> RELEASE_BODY.md
          echo "- üîó [Android Release Keystore SHA1](https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/app-release.keystore.sha1)" >> RELEASE_BODY.md
          echo "- üß™ [Test Report (Robot Framework)](https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/tests/report.html)" >> RELEASE_BODY.md
          echo "- üß™ [Test Log](https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/tests/log.html)" >> RELEASE_BODY.md
          echo "- üìä [Test Output (XML)](https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/tests/output.xml)" >> RELEASE_BODY.md
          echo "- üßæ [Build Log](https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/build/images-build.html)" >> RELEASE_BODY.md
          echo "- üßæ [Docker Tags](https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/docker-tags.md)" >> RELEASE_BODY.md
          echo "_Generated automatically by Vegito CI/CD pipeline üß±_" >> RELEASE_BODY.md
          echo "# üöÄ Release $VERSION" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "## üß© Changes included:" >> RELEASE_BODY.md
          cat ./artifacts/CHANGELOG.md >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md

      # --- T√©l√©chargement minimal des artefacts n√©cessaires √† la g√©n√©ration du RELEASE_BODY.md ---
      - name: Download environment artifacts from GCS (minimal)
        run: |
          set -euo pipefail
          for env in prod staging dev; do
            env_artifacts_dir="./artifacts/$env"
            mkdir -p "$env_artifacts_dir"
            echo "üîé Downloading Android keystore SHA1 for $env..."
            gcloud storage cp "gs://vegito-app-${env}-github-actions-ci-artifacts/${{ github.repository }}/${VERSION}/android-mobile-release-${VERSION}-key.keystore.sha1" "$env_artifacts_dir/android-mobile-release-${VERSION}-key.keystore.sha1" || echo "No keystore SHA1 for $env"
            echo "üîé Downloading docker-tags.md for $env..."
            gcloud storage cp "gs://vegito-app-${env}-github-actions-ci-artifacts/${{ github.repository }}/${VERSION}/docker-tags.md" "$env_artifacts_dir/docker-tags.md" || echo "No docker-tags.md for $env"
          done
          # Le changelog est d√©j√† t√©l√©charg√© plus haut

      - name: Download Robot Framework artifacts from GCS (for release body)
        run: |
          set -euo pipefail
          for env in prod staging dev; do
            env_dir="./artifacts/$env/tests"
            mkdir -p "$env_dir"
            gcloud storage cp "gs://vegito-app-${env}-github-actions-ci-artifacts/${{ github.repository }}/${VERSION}/tests/report.html" "$env_dir/report.html" || true
            gcloud storage cp "gs://vegito-app-${env}-github-actions-ci-artifacts/${{ github.repository }}/${VERSION}/tests/log.html" "$env_dir/log.html" || true
            gcloud storage cp "gs://vegito-app-${env}-github-actions-ci-artifacts/${{ github.repository }}/${VERSION}/tests/output.xml" "$env_dir/output.xml" || true
          done

      - name: Append environment-specific information to changelog
        run: |
          set -euo pipefail
          for env in prod staging dev; do
            echo -e "\n\n---\n\n" >> RELEASE_BODY.md
            echo "### [$env] Environment Artifacts:" >> RELEASE_BODY.md
            echo "" >> RELEASE_BODY.md
            
            # Append Android keystore SHA1 if available
            keystore_sha1_path="./artifacts/$env/android-mobile-release-${VERSION}-key.keystore.sha1"
            if [ -f "$keystore_sha1_path" ]; then
              echo "**Android Release Keystore SHA1:**" >> RELEASE_BODY.md
              echo '```' >> RELEASE_BODY.md
              cat "$keystore_sha1_path" >> RELEASE_BODY.md
              echo '' >> RELEASE_BODY.md
              echo '```' >> RELEASE_BODY.md
              echo "" >> RELEASE_BODY.md
            fi

            docker_tags_path="./artifacts/$env/docker-tags.md"
            if [ -f "$docker_tags_path" ]; then
              echo "**Docker images published:**" >> RELEASE_BODY.md
              cat "$docker_tags_path" >> RELEASE_BODY.md
              echo "" >> RELEASE_BODY.md
            fi

            tests_dir="./artifacts/$env/tests"
            if [ -d "$tests_dir" ]; then
              if [ -f "$tests_dir/report.html" ] || [ -f "$tests_dir/log.html" ] || [ -f "$tests_dir/output.xml" ]; then
                echo "**Robot Framework Tests:**" >> RELEASE_BODY.md
                [ -f "$tests_dir/report.html" ] && echo "- üß™ Test Report: https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/tests/report.html" >> RELEASE_BODY.md
                [ -f "$tests_dir/log.html" ] && echo "- üß™ Test Log: https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/tests/log.html" >> RELEASE_BODY.md
                [ -f "$tests_dir/output.xml" ] && echo "- üìä Test Output (XML): https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}/tests/output.xml" >> RELEASE_BODY.md
                echo "" >> RELEASE_BODY.md
              fi
            fi
          done

      - name: Show Release Body preview
        run: |
          cat RELEASE_BODY.md

      - name: Create GitHub Release ‚ú®
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: main-${{ env.VERSION }}
          name: Release ${{ env.VERSION }}
          body_path: ./RELEASE_BODY.md

  commit-and-push-release-tag:
    name: Finalize and Push Release Tag
    runs-on: self-hosted
    needs: [create-github-release, upload-release-to-gcs]
    if: success()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Reset to clean state
        run: |
          git fetch origin main
          git reset --hard origin/main

      - name: Run Gitleaks scan
        run: |
          gitleaks detect --source . --report-path gitleaks-report.json --log-opts "--all"

      # - name: Upload Gitleaks report as artifact
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: gitleaks-report
      #     path: gitleaks-report.json
      # TODO: Uploader direct vers GCS √† la g√©n√©ration (gitleaks-report.json)

      - name: Fail if leaks found
        run: |
          if grep -q '"line":' gitleaks-report.json; then
            echo "üö® Secrets found, stopping build!"
            exit 1
          fi

      - name: Recreate version tag
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "build-and-push-images-action@github.com"
          standard-version

      - name: Push tag if all builds succeeded
        run: |
          git push origin HEAD --follow-tags

  upload-release-to-gcs:
    strategy:
      matrix:
        environment: [dev, staging, prod]
    name: Upload ${{ matrix.environment }} artifacts and metadata to GCS
    runs-on: self-hosted
    environment: ${{ matrix.environment }}
    env:
      VERSION: ${{ inputs.version }}
      VEGITO_PROJECT_USER: gha-${{ github.run_id }}-${{ inputs.environment }}
      GOOGLE_CLOUD_PROJECT_ID: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
      GOOGLE_CLOUD_PROJECT_NUMBER: ${{ secrets.GOOGLE_CLOUD_PROJECT_NUMBER }}
      WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
      GOOGLE_CLOUD_SA_KEY_GITHUB_ACTIONS_MAIN: ${{ secrets.GOOGLE_CLOUD_SA_KEY_GITHUB_ACTIONS_MAIN }}
      INFRA_ENV: ${{ matrix.environment }}
      GCS_BUCKET: gs://vegito-ci-artifacts-${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
      GCS_BUCKET_NAME: vegito-app-${{ matrix.environment }}-github-actions-ci-artifacts
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set VERSION
        run: echo "VERSION=${{ env.VERSION }}" >> $GITHUB_ENV

      - name: Authenticate to Google Cloud via Workload Identity Federation
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.GOOGLE_CLOUD_SA_KEY_GITHUB_ACTIONS_MAIN }}
          project_id: ${{ env.GOOGLE_CLOUD_PROJECT_ID }}
          token_format: "access_token"
          export_environment_variables: true

      - name: Download docker metadata artifact from GCS
        run: |
          mkdir -p ./artifacts
          gcloud storage cp "gs://vegito-app-${{ matrix.environment }}-github-actions-ci-artifacts/${{ github.repository }}/${{ env.VERSION }}/docker-tags.md" ./artifacts/docker-tags.md || true

      - name: Download build log artifact from GCS
        run: |
          mkdir -p ./artifacts/build
          gcloud storage cp "gs://vegito-app-${{ matrix.environment }}-github-actions-ci-artifacts/${{ env.VERSION }}/images-build.log" ./artifacts/build/images-build.log || true

      - name: Download dev logs from GCS
        if: env.INFRA_ENV == 'dev'
        run: |
          mkdir -p ./artifacts/dev
          gcloud storage cp "gs://vegito-app-${{ matrix.environment }}-github-actions-ci-artifacts/${{ env.VERSION }}/setup.log" ./artifacts/dev/setup.log || true
          gcloud storage cp "gs://vegito-app-${{ matrix.environment }}-github-actions-ci-artifacts/${{ env.VERSION }}/containers.log" ./artifacts/dev/containers.log || true
          gcloud storage cp "gs://vegito-app-${{ matrix.environment }}-github-actions-ci-artifacts/${{ env.VERSION }}/tests.log" ./artifacts/dev/tests.log || true

      - name: Download mobile preview artifact from GCS
        if: env.INFRA_ENV == 'dev'
        run: |
          mkdir -p ./artifacts/mobile
          gcloud storage cp "gs://vegito-app-${{ matrix.environment }}-github-actions-ci-artifacts/${{ env.VERSION }}/android-mobile-preview.png" ./artifacts/mobile/android-mobile-preview.png || true

      - name: Download tests results from GCS
        if: env.INFRA_ENV == 'dev'
        run: |
          mkdir -p ./artifacts/tests
          gcloud storage cp "gs://vegito-app-${{ matrix.environment }}-github-actions-ci-artifacts/${{ env.VERSION }}/tests/report.html" ./artifacts/tests/report.html || true
          gcloud storage cp "gs://vegito-app-${{ matrix.environment }}-github-actions-ci-artifacts/${{ env.VERSION }}/tests/log.html" ./artifacts/tests/log.html || true
          gcloud storage cp "gs://vegito-app-${{ matrix.environment }}-github-actions-ci-artifacts/${{ env.VERSION }}/tests/output.xml" ./artifacts/tests/output.xml || true

      - name: Download APK and AAB artifacts from GCS
        run: |
          mkdir -p ./artifacts/android
          gcloud storage cp "gs://vegito-app-${{ matrix.environment }}-github-actions-ci-artifacts/${{ env.VERSION }}/android-mobile-release-${{ env.VERSION }}-signed-aligned.apk" ./artifacts/android/android-mobile-release-${{ env.VERSION }}-signed-aligned.apk || true
          gcloud storage cp "gs://vegito-app-${{ matrix.environment }}-github-actions-ci-artifacts/${{ env.VERSION }}/android-mobile-release-${{ env.VERSION }}-signed.aab" ./artifacts/android/android-mobile-release-${{ env.VERSION }}-signed.aab || true
          gcloud storage cp "gs://vegito-app-${{ matrix.environment }}-github-actions-ci-artifacts/${{ env.VERSION }}/android-mobile-release-${{ env.VERSION }}-key.keystore.sha1" ./artifacts/android/android-mobile-release-${{ env.VERSION }}-key.keystore.sha1 || true

      - name: Download Robot Framework reports from GCS
        run: |
          for env in prod staging dev; do
            env_artifacts_dir="./artifacts/$env"
            mkdir -p "$env_artifacts_dir"
            gcloud storage cp "gs://vegito-app-${{ matrix.environment }}-github-actions-ci-artifacts/${{ github.repository }}/${VERSION}/tests/report.html" "$env_artifacts_dir/report.html" || echo "No report.html for $env"
            gcloud storage cp "gs://vegito-app-${{ matrix.environment }}-github-actions-ci-artifacts/${{ github.repository }}/${VERSION}/tests/log.html" "$env_artifacts_dir/log.html" || echo "No log.html for $env"
            gcloud storage cp "gs://vegito-app-${{ matrix.environment }}-github-actions-ci-artifacts/${{ github.repository }}/${VERSION}/tests/output.xml" "$env_artifacts_dir/output.xml" || echo "No output.xml for $env"
          done

      - name: Upload metadata.json and APK/AAB to GCS
        run: |
          apkUrl="https://storage.googleapis.com/${gs_path}/app-release.apk"

          qrencode -o ./artifacts/qr-code.png "${apkUrl}"

          if [ -f ./artifacts/dev/containers.log ]; then
            echo "<html><body><pre>" > ./artifacts/dev/containers.html
            cat ./artifacts/dev/containers.log >> ./artifacts/dev/containers.html
            echo "</pre></body></html>" >> ./artifacts/dev/containers.html
          fi

          if [ -f ./artifacts/dev/setup.log ]; then
            echo "<html><body><pre>" > ./artifacts/dev/setup.html
            cat ./artifacts/dev/setup.log >> ./artifacts/dev/setup.html
            echo "</pre></body></html>" >> ./artifacts/dev/setup.html
          fi

          if [ -f ./artifacts/dev/tests.log ]; then
            echo "<html><body><pre>" > ./artifacts/dev/tests.html
            cat ./artifacts/dev/tests.log >> ./artifacts/dev/tests.html
            echo "</pre></body></html>" >> ./artifacts/dev/tests.html
          fi

          if [ -f ./artifacts/build/images-build.log ]; then
            echo "<html><body><pre>" > ./artifacts/build/images-build.html
            cat ./artifacts/build/images-build.log >> ./artifacts/build/images-build.html
            echo "</pre></body></html>" >> ./artifacts/build/images-build.html
          fi

          gs_path="${GCS_BUCKET_NAME}/${GITHUB_REPOSITORY}/${VERSION}"
          mkdir -p temp_metadata
          METADATA_PATH=temp_metadata/metadata.json
          cat <<EOF > $METADATA_PATH
          {
            "version": "${VERSION}",
            "changelog": "https://storage.googleapis.com/${gs_path}/CHANGELOG.md",
            "dockerTags": "https://storage.googleapis.com/${gs_path}/docker-tags.md",
            "apk": "${apkUrl}",
            "aab": "https://storage.googleapis.com/${gs_path}/app-release.aab",
            "androidKeystoreSha1": "https://storage.googleapis.com/${gs_path}/app-release.keystore.sha1",
            "thumbnail": "https://storage.googleapis.com/${gs_path}/mobile/android-preview.png",
            "robotReport": "https://storage.googleapis.com/${gs_path}/tests/report.html",
            "robotLog": "https://storage.googleapis.com/${gs_path}/tests/log.html",
            "robotXml": "https://storage.googleapis.com/${gs_path}/tests/output.xml",
            "buildImages": "https://storage.googleapis.com/${gs_path}/build/images-build.html",
            "buildImagesLog": "https://storage.googleapis.com/${gs_path}/build/images-build.log",
            "devTests": "https://storage.googleapis.com/${gs_path}/dev/tests.html",
            "devTestsLog": "https://storage.googleapis.com/${gs_path}/dev/tests.log",
            "devContainers": "https://storage.googleapis.com/${gs_path}/dev/containers.html",
            "devContainersLog": "https://storage.googleapis.com/${gs_path}/dev/containers.log",
            "devSetup": "https://storage.googleapis.com/${gs_path}/dev/setup.html",
            "devSetupLog": "https://storage.googleapis.com/${gs_path}/dev/setup.log",
            "qr": "https://storage.googleapis.com/${gs_path}/qr-code.png"
          }
          EOF

          gcloud storage cp "$METADATA_PATH" "gs://$gs_path/metadata.json" --quiet

          gcloud storage cp ./artifacts/android/android-mobile-release-${{ inputs.version }}-signed-aligned.apk "gs://$gs_path/app-release.apk" --quiet
          gcloud storage cp ./artifacts/android/android-mobile-release-${{ inputs.version }}-signed.aab "gs://$gs_path/app-release.aab" --quiet
          gcloud storage cp ./artifacts/android/android-mobile-release-${{ inputs.version }}-key.keystore.sha1 "gs://$gs_path/app-release.keystore.sha1" --quiet


          gcloud storage cp ./artifacts/build/images-build.html "gs://$gs_path/build/images-build.html" --quiet
          gcloud storage cp ./artifacts/build/images-build.log "gs://$gs_path/build/images-build.log" --quiet

          # Upload dev logs uniquement si env == dev
          if [ "$INFRA_ENV" = "dev" ]; then
            gcloud storage cp ./artifacts/mobile/android-mobile-preview.png "gs://$gs_path/mobile/android-preview.png" --quiet
            gcloud storage cp ./artifacts/dev/tests.html "gs://$gs_path/dev/tests.html" --quiet || true
            gcloud storage cp ./artifacts/dev/tests.log "gs://$gs_path/dev/tests.log" --quiet || true
            gcloud storage cp ./artifacts/dev/setup.html "gs://$gs_path/dev/setup.html" --quiet || true
            gcloud storage cp ./artifacts/dev/setup.log "gs://$gs_path/dev/setup.log" --quiet || true
            gcloud storage cp ./artifacts/dev/containers.html "gs://$gs_path/dev/containers.html" --quiet
            gcloud storage cp ./artifacts/dev/containers.log "gs://$gs_path/dev/containers.log" --quiet
          fi

          gcloud storage cp ./artifacts/qr-code.png "gs://$gs_path/qr-code.png" --quiet
