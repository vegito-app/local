name: Backend Release (DRY, Version & Changelog)
permissions:
  id-token: write
  contents: write
on:
  workflow_call:
    inputs:
      version:
        description: "Semantic version to release (already computed)"
        required: true
        type: string

      environment:
        description: "Reference environment for the release (dev, staging, prod)"
        required: true
        type: string

      release_bucket_name:
        required: true
        type: string

      release_bucket_prefix:
        required: false
        type: string
        default: ${{ github.repository }}

      application_release_bucket_project_prefix:
        required: false
        type: string
        default: local

      create_github_release:
        description: "Whether to create a GitHub Release"
        required: false
        type: boolean
        default: false

      release_title_prefix:
        description: "Prefix for GitHub Release title"
        required: false
        type: string
        default: "Backend release"
    secrets:
      GOOGLE_CLOUD_PROJECT_ID:
        required: true
      GOOGLE_CLOUD_SA_KEY_GITHUB_ACTIONS_MAIN:
        required: true
      WORKLOAD_IDENTITY_PROVIDER:
        required: true
    outputs:
      release_notes_path:
        description: "Path to the prepared release notes file"
        value: ${{ jobs.prepare-notes.outputs.notes_path }}

jobs:
  prepare-notes:
    name: Prepare Release Notes
    runs-on: self-hosted
    environment: ${{ inputs.environment }}

    outputs:
      notes_path: ${{ steps.notes.outputs.path }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GOOGLE_CLOUD_SA_KEY_GITHUB_ACTIONS_MAIN }}
          project_id: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
          token_format: "access_token"
          export_environment_variables: true
          
      - name: Download version changelog from GCS
        run: |
          gs_path="gs://${{ inputs.release_bucket_name }}/${{ inputs.release_bucket_prefix }}/${{ inputs.version }}"
          gcloud storage cp "$gs_path/CHANGELOG.md" ./CHANGELOG.md || true

      - name: Prepare release notes
        id: notes
        run: |
          NOTES_PATH=RELEASE_NOTES.md
          VERSION="${{ inputs.version }}"
          VEGITO_APPLICATION_RELEASE_PROJECT="${{ inputs.application_release_bucket_project_prefix }}"
          VEGITO_APPLICATION_RELEASE_BUCKET="${{ inputs.release_bucket_name }}/${{ inputs.release_bucket_prefix }}"
          BASE_URL="https://storage.googleapis.com/${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}"

          echo "# üöÄ Backend Release ${VERSION}" > ${NOTES_PATH}
          echo "" >> ${NOTES_PATH}
          echo "This release contains backend changes only." >> ${NOTES_PATH}
          echo "" >> ${NOTES_PATH}

          echo "## üîó Artifacts & Reports (GCS)" >> ${NOTES_PATH}
          echo "" >> ${NOTES_PATH}
          echo "Artifacts are published in the Vegito release bucket for project \`${VEGITO_APPLICATION_RELEASE_PROJECT}\`:" >> ${NOTES_PATH}
          echo "" >> ${NOTES_PATH}
          echo "- üõ°Ô∏è **Trivy Security Report**: ${BASE_URL}/trivy/trivy-report.html" >> ${NOTES_PATH}
          echo "- ü§ñ **Robot Framework Report**: ${BASE_URL}/tests/report.html" >> ${NOTES_PATH}
          echo "- üìã **Robot Framework Log**: ${BASE_URL}/tests/log.html" >> ${NOTES_PATH}
          echo "- üßæ **Robot Framework Output (XML)**: ${BASE_URL}/tests/output.xml" >> ${NOTES_PATH}
          echo "" >> ${NOTES_PATH}
          echo "## üß™ CI Logs & Build Reports" >> ${NOTES_PATH}
          echo "" >> ${NOTES_PATH}
          echo "- üõ†Ô∏è **Images Build Log (raw)**: ${BASE_URL}/images-build.log" >> ${NOTES_PATH}
          echo "- üß∞ **Dev Containers Log (raw)**: ${BASE_URL}/dev/containers.log" >> ${NOTES_PATH}
          echo "- üîß **Dev Setup Log (raw)**: ${BASE_URL}/dev/setup.log" >> ${NOTES_PATH}
          echo "- üß™ **Functional Tests Log (raw)**: ${BASE_URL}/dev/tests.log" >> ${NOTES_PATH}
          echo "" >> ${NOTES_PATH}
          echo "---" >> ${NOTES_PATH}
          echo "" >> ${NOTES_PATH}

          if [ -f CHANGELOG.md ]; then
            echo "## üß© Changelog" >> ${NOTES_PATH}
            echo "" >> ${NOTES_PATH}
            cat CHANGELOG.md >> ${NOTES_PATH}
          else
            echo "_No changelog file found._" >> ${NOTES_PATH}
          fi

          echo "Uploading RELEASE_NOTES.md to GCS"
          gcloud storage cp "${NOTES_PATH}" \
            "gs://${{ inputs.release_bucket_name }}/${{ inputs.release_bucket_prefix }}/${{ inputs.version }}/RELEASE_NOTES.md"

          echo "path=${NOTES_PATH}" >> $GITHUB_OUTPUT

      # Plus d'upload artifact, les RELEASE_NOTES seront t√©l√©charg√©es depuis GCS dans l'autre job

  # --- upload-release-to-gcs job ---
  upload-release-to-gcs:
    name: Upload ${{ inputs.environment }} artifacts and metadata to GCS
    runs-on: self-hosted
    environment: ${{ inputs.environment }}
    env:
      VERSION: ${{ inputs.version }}
      VEGITO_PROJECT_USER: gha-${{ github.run_id }}-${{ inputs.environment }}
      WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
      GOOGLE_CLOUD_SA_KEY_GITHUB_ACTIONS_MAIN: ${{ secrets.GOOGLE_CLOUD_SA_KEY_GITHUB_ACTIONS_MAIN }}
      GOOGLE_CLOUD_PROJECT_ID: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
      INFRA_ENV: ${{ inputs.environment }}
      VEGITO_APPLICATION_RELEASE_BUCKET: ${{ inputs.release_bucket_name }}/${{ inputs.release_bucket_prefix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.GOOGLE_CLOUD_SA_KEY_GITHUB_ACTIONS_MAIN }}
          project_id: ${{ env.GOOGLE_CLOUD_PROJECT_ID }}
          token_format: access_token
          export_environment_variables: true

      # T√©l√©chargement des artefacts de release depuis GCS
      - name: Download release artifacts from GCS
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          mkdir -p artifacts/build artifacts/dev artifacts/tests artifacts/rf-reports
          gs_path="gs://${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}"
          # Release notes
          gcloud storage cp "$gs_path/RELEASE_NOTES.md" "artifacts/RELEASE_NOTES.md" || true
          # Build log
          gcloud storage cp "$gs_path/images-build.log" "artifacts/build/images-build.log" || true
          # Dev logs (dev only)
          gcloud storage cp "$gs_path/dev/containers.log" "artifacts/dev/containers.log" || true
          gcloud storage cp "$gs_path/dev/setup.log" "artifacts/dev/setup.log" || true
          gcloud storage cp "$gs_path/dev/tests.log" "artifacts/dev/tests.log" || true
          # Robot Framework reports
          gcloud storage cp "$gs_path/tests/report.html" "artifacts/tests/report.html" || true
          gcloud storage cp "$gs_path/tests/log.html" "artifacts/tests/log.html" || true
          gcloud storage cp "$gs_path/tests/output.xml" "artifacts/tests/output.xml" || true
          # Trivy report
          gcloud storage cp "$gs_path/trivy/trivy-report.html" "artifacts/trivy-report.html" || true

      - name: Generate and upload metadata.json
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          gs_path="${VEGITO_APPLICATION_RELEASE_BUCKET}/${VERSION}"
          METADATA_PATH=metadata.json

          cat <<EOF > $METADATA_PATH
          {
            "version": "${VERSION}",
            "project": "${GITHUB_REPOSITORY}",
            "backend": true,
            "artifactsBase": "https://storage.googleapis.com/${gs_path}",
            "releaseNotes": "https://storage.googleapis.com/${gs_path}/RELEASE_NOTES.md",
            "security": {
              "trivyReport": "https://storage.googleapis.com/${gs_path}/trivy/trivy-report.html"
            },
            "tests": {
              "robotReport": "https://storage.googleapis.com/${gs_path}/tests/report.html",
              "robotLog": "https://storage.googleapis.com/${gs_path}/tests/log.html",
              "robotXml": "https://storage.googleapis.com/${gs_path}/tests/output.xml"
            },
            "build": {
              "imagesBuildLog": "https://storage.googleapis.com/${gs_path}/images-build.log"
            },
            "development": {
              "functionalTestsLog": "https://storage.googleapis.com/${gs_path}/dev/tests.log",
              "containersLog": "https://storage.googleapis.com/${gs_path}/dev/containers.log",
              "devSetupLog": "https://storage.googleapis.com/${gs_path}/dev/setup.log"
            }
          }
          EOF

          gcloud storage cp "$METADATA_PATH" "gs://$gs_path/metadata.json" --quiet
