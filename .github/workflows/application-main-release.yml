name: Application Release Build

permissions:
  id-token: write
  contents: write

on:
  push:
    branches: [main]
jobs:
  version:
    name: Generate Version and Changelog
    uses: ./.github/workflows/version.yml

  build:
    needs: version
    name: Build and Push Images
    uses: ./.github/workflows/build-images.yml
    strategy:
      matrix:
        environment: [dev, staging, prod]
    with:
      version: ${{ needs.version.outputs.version }}
      environment: ${{ matrix.environment }}
      # use_registry_cache: true
      android_release_keystore_path: example-application/mobile/android/release-key.keystore
      android_release_keystore_base64_path: example-application/mobile/android/release-key.keystore.base64
      android_release_keystore_store_pass_base64_path: example-application/mobile/android/release-key.keystore.storepass.base64
    secrets:
      WORKLOAD_IDENTITY_PROVIDER: projects/${{ secrets.GOOGLE_CLOUD_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ vars.WORKLOAD_IDENTITY_POOL_ID }}/providers/${{ vars.WORKLOAD_IDENTITY_PROVIDER_ID }}
      GOOGLE_CLOUD_SA_KEY_GITHUB_ACTIONS_MAIN: github-actions-main@${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}.iam.gserviceaccount.com
      GOOGLE_CLOUD_PROJECT_ID: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
      ANDROID_RELEASE_KEYSTORE: ${{ secrets.ANDROID_RELEASE_KEYSTORE }}
      ANDROID_RELEASE_KEYSTORE_STORE_PASS: ${{ secrets.ANDROID_RELEASE_KEYSTORE_STORE_PASS }}

  trivy-scan:
    runs-on: self-hosted
    name: Run Trivy Scan
    needs:
      - build
      - version
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image (si non publiÃ©)
        run: |
          docker build -t vegito-backend:${{ github.sha }} -f vegito/Dockerfile .

      - name: Run Trivy scan (HTML report)
        uses: aquasecurity/trivy-action@v0.17.0
        with:
          image-ref: vegito-backend:${{ github.sha }}
          format: 'template'
          template: '@/contrib/html.tpl'
          output: 'trivy-report.html'

      - name: Upload Trivy HTML report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.html

  test:
    needs:
      - build
      - version
    name: Run Tests
    uses: ./.github/workflows/functional-tests.yml
    strategy:
      matrix:
        environment: [dev, staging, prod]
    with:
      version: ${{ needs.version.outputs.version }}
      environment: ${{ matrix.environment }}
      functional-tests-output-dir: example-application/tests/output
    secrets:
      GOOGLE_CLOUD_PROJECT_ID: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
      WORKLOAD_IDENTITY_PROVIDER: projects/${{ secrets.GOOGLE_CLOUD_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ vars.WORKLOAD_IDENTITY_POOL_ID }}/providers/${{ vars.WORKLOAD_IDENTITY_PROVIDER_ID }}
      GOOGLE_CLOUD_SA_KEY_GITHUB_ACTIONS_MAIN: github-actions-main@${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}.iam.gserviceaccount.com

  application-release-build:
    needs:
      - build
      - test
      - version
    name: Application Release Build ðŸš€
    uses: ./.github/workflows/application-release-template.yml
    with:
      environment: dev
      version: ${{ needs.version.outputs.version }}
    secrets:
      GOOGLE_CLOUD_PROJECT_ID: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
      WORKLOAD_IDENTITY_PROVIDER: projects/${{ secrets.GOOGLE_CLOUD_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ vars.WORKLOAD_IDENTITY_POOL_ID }}/providers/${{ vars.WORKLOAD_IDENTITY_PROVIDER_ID }}
      GOOGLE_CLOUD_SA_KEY_GITHUB_ACTIONS_MAIN: github-actions-main@${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}.iam.gserviceaccount.com
