# This workflow PREPARES a release:
# - computes next semantic version using standard-version
# - generates CHANGELOG.md
# - exposes VERSION and CHANGELOG as outputs
# - DOES NOT push commits or tags
# Tag push must be handled by a dedicated finalize workflow.

name: Version Prepare (Reusable)
on:
  workflow_call:
    inputs:
      environment:
        description: "Environment"
        required: true
        type: string
    outputs:
      version:
        description: "Version number generated"
        value: ${{ jobs.define_version.outputs.version }}
      changelog:
        description: "Generated changelog content"
        value: ${{ jobs.define_version.outputs.changelog }}
    secrets:
      GOOGLE_CLOUD_PROJECT_ID:
        required: true
      WORKLOAD_IDENTITY_PROVIDER:
        required: true
      GOOGLE_CLOUD_SA_KEY_GITHUB_ACTIONS_MAIN:
        required: true

permissions:
  contents: read
  id-token: write

jobs:
  define_version:
    name: Define VERSION âœ¨
    runs-on: self-hosted
    environment: ${{ inputs.environment }}
    outputs:
      version: ${{ steps.define_version.outputs.VERSION }}
      changelog: ${{ steps.define_version.outputs.CHANGELOG_NEW }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GOOGLE_CLOUD_SA_KEY_GITHUB_ACTIONS_MAIN }}
          project_id: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
          token_format: "access_token"
          export_environment_variables: true

      - name: Define VERSION and Tag ðŸ·
        id: define_version
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "build-and-push-images-action@github.com"

          # Bump the version based on commit messages (default patch bump)
          touch CHANGELOG.old.md
          if [ -f CHANGELOG.md ]; then cat CHANGELOG.md >> CHANGELOG.old.md; fi
          rm -f CHANGELOG.md
          git fetch --tags
          echo "Commit release bump and tag will be pushed after build success"
          standard-version --skip.commit
          echo "CHANGELOG_NEW<<EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "ðŸ“ CHANGELOG (new only):"
          VERSION=$(git describe --tags --abbrev=7 --match 'v*')
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Prepared version: $VERSION (not pushed)"

      - name: Show New Changes log
        run: |
          cat CHANGELOG.md

      - name: Upload New Changes Changelog to GCS
        run: |
          gcloud storage cp CHANGELOG.md gs://vegito-app-dev-github-actions-ci-artifacts/${{ github.repository }}/${{ steps.define_version.outputs.version }}/CHANGELOG.md
